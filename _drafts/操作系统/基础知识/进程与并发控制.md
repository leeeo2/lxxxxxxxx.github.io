
 # 操作系统4个基本特征
 
 并发、共享、虚拟、不确定性

- 并发 
并行性与并发性的区别：并行性指多个事件在同一时刻发生，并发性指多个事件在同一时间间隔发生。并行性需要硬件支持。


- 共享
硬件资源有限，操作系统需要协调多个用户提出的需资源请求。资源共享方式根据资源不同分为互斥共享和同时共享。

- 虚拟性
虚拟指一个物理上的实体映射为多个逻辑上的对应物，如一个CPU采用分时技术，将一个CPU虚拟为多个CPU，每个用户感觉CPU都在为自己工作。
虚拟性还体现在其他方面，如虚拟存储，虚拟设备，虚拟通道，虚拟文件，虚拟用户，虚拟网络等。

- 不确定性
不确定性体现在，① 程序执行结果不确定，程序不可再现（这种不确定性不允许出现，需要在操作系统设计时给以解决）；②多道程序环境下程序以异步方式执行，程序执行时刻、顺序不确定。

# 一些概念
- 多道程序
为充分利用CPU、IO等硬件资源，将多个程序同时加载到内存中，在一个作业运行间隙，运行另一个作业。

- 进程与线程
程序是静态的二进制文件，而进程是运行起来的程序或者程序的一次运行，线程是对进程的有效细分。进程是资源分配的逻辑单位，线程才是系统调度的基本单位。

# 系统内核
- 系统内核是操作系统的核心，它将与硬件密切相关的、运行频率较高、基础的、公共的模块独立出来，常驻内存，并进行特殊保护。

- 内核主要提供资源管理和基本支撑功能：
**资源管理包括**：进程管理、存储管理、IO设备管理。
**支撑功能包括**：中断处理、原语操作、时钟管理、系统监测等。

- 原语操作
**原语**：是机器指令的延伸，由若干机器指令组成，完成一个功能。
**原子操作**：一个操作要么不做，要不就做完，不会做到一半被中断，如进程创建、进程销毁、进程状态改变等。原子操作可以通过 **屏蔽中断** 来实现。


# 进程

- 进程是程序的一次执行，具有四个特征：**动态性，并发性，独立性，异步性**。
- 进程是系统分配资源的基本单位，不是调度的基本单位（老操作系统中是调度的基本单位因为没有线程）
- 进程的结构特征：进程 = 程序段 + 数据 + PCB，PCB是程序控制块（Process Control Block），是进程存在的标识，创建进程即创建PCB，销毁进程即销毁PCB。

## 进程五状态模型
**新建、就绪、执行、阻塞、终止**

1. 新建状态（新建PCB）
新建了PCB但是还未将程序加载到内存，数据还未准备完成，由于操作系统限制最大可执行进程数量或内存大小限制，新建的进程不能立即进入就绪状态。

2. 就绪状态（完事具备，只欠CPU）
由于CPU被其他进程占用，不能立即运行进程，此时状态的进程，只要得到CPU就能直接运行。由于同时可能有多个进程处于就绪状态，所以用队列将他们组织起来。

3. 执行状态（获得CPU）
进程被调度，获得CPU，进入执行状态。

4. 阻塞状态（等待状态）
进程由于等待事件而阻塞，如等待IO完成，或者等待某个事件通知。由于同时可能有多个进程由于相同的原因而阻塞，所以通过队列来将他们组织成不同的队列，一旦阻塞事件解除，进程又可以参与调度。

5. 终止状态（正常或异常退出）
进程运行结束，或遇到异常而退出，但进程还未从内存中销毁时处于该状态，系统正在对该进程做一些处理，如统计运行时间等，一旦处理完成，就会将该进程从内存撤销。

> **新建** == 接纳 ==> **就绪** == 调度 ==> **执行**  == 完成或异常 ==>  **终止**
> **执行** == 等待事件 ==> **阻塞** == 事件发生 ==> **就绪**
> **执行** == 时间片完 ==> **就绪**


## 进程七状态模型：挂起

“对换技术”是指操作系统利用将处于阻塞或就绪状态的进程，全部或部分程序和数据从内存换出到磁盘，以腾出内存空间来执行其他进程的操作。   
被换出的进程可能转换为挂起状态，该进程被插入到挂起队列。（换出并不一定都转换为挂起状态，虚存部分会详细说明）。

七状态模型是在五状态模型之上，加入了就绪挂起和阻塞挂起两个状态组成的。

6. 就绪挂起
系统将就绪状态的进程换出。

7. 阻塞挂起
系统将阻塞状态的进程换出。

七状态模型中，除了新建和终止，其他状态都能转换为就绪挂起状态，可以动手画一下状态转换图。

## 进程的组成

进程由程序、数据集合、PCB组成，系统中通常存在一个初始化进程，所有的其他进程都直接或间接由它创建，他们的关系可以由**树形结构**表示。

进程控制快（PCB）是进程在系统中的唯一标识，系统通过PCB记录、跟踪、控制进程。PCB通常由如下几部分组成：   
- 标识符信息    
包括外部标识和内部标识（外部标识就是程序名？内部标识就是PID？）

- 处理器状态信息    
存放处理器状态的寄存器信息。

- 进程调度信息    
存放进程调度和对换相关信息，如进程状态、优先级等。

- 其他信息    
存放程序和数据地址，同步和通信机制，资源清单，链接指针（进程通过链表存储）。

# 线程
## 线程的引入
- 进程的创建、调度和管理需要付出很大的额外开销，如创建进程需要分配资源，结束需要释放资源。为了保持系统的并发性，同时降低管理进程的大开销，引入了线程。     
- 进程作为资源分配和拥有的基本单位，而线程作为调度的基本单位。

## 线程与进程的区别
从如下四部分来比较线程与进程：

1. 调度    
现代操作系统中，线程作为调度的基本单位，而进程是资源拥有的基本单位。同一进程的不同线程切换不会引起进程切换，但不同进程间的现场切换，会引起进程切换。

2. 并发性    
引入线程后，不仅进程间可以并发执行，同一进程的不同线程也可以并发执行。提供了系统资源使用效率是系统吞吐量。

3. 拥有资源    
进程是资源分配和拥有的基本单位，线程出拥有少量私有资源外（程序计数器，栈，一组寄存器等），共享所属进程的资源，如代码段、数据段、系统资源。

4. 系统开销    
- 进程和线程的系统开销差别主要体现在两方面：创建销毁和调度，进程创建销毁时需要分配或回收资源，包括内存空间、IO设备等，调度时需要保存的上下文也比较复杂。    
- 相对来说，线程创建销毁比较简单，切换是也只需保存少量的寄存器内容，并且不涉及存储器的管理操作。    
- 此外，同一进程的不同线程具有相同的地址空间，线程间同步和通信也比较简单。

# 进程调度
## 概述

1. 进程调度的通用算法
```
while(调度){
    for( ProcessQueue ){
        选择一个符合条件的进程返回；  //关键在于如何选择符合条件的进程
    }
    if(没有符合执行条件的进程){
        CPU空闲；
    }
}

```

2. 进程调度目标
防止进程长期不能获得调度，尽量提高处理器利用率，提供系统吞吐量，尽量减少进程响应时间。

3. 调度的类型
- 长程调度：又称为作业调度，他为被调度作业创建进程，分配资源，插入到就绪队列，等待短程调度。

- 中程调度：是对换功能的一部分，内存紧张或没有可执行进程时，选择一个就绪或阻塞的进程换出到外存；当内存空间宽裕时，从外存选择一个挂起的进程换入到内存。

- 短程调度：又称为进程调度，决定就绪队列中的进程获得处理器。

## 调度算法


### 1.先来先服务 (FCFS)
是非剥夺式算法，该算法按照进程到来的先后顺序调度，先来先运行，执行完一个进程再调度下一个进程。

缺点：对于运行时间较短但排在后面的进程不公平，对于某些计算型进程可能长时间占用CPU。    

FCFS一般和其他调度算法一起使用，如多个就绪队列，每个就绪队列按照FCFS算法执行，执行完一个队列再执行下一个队列。

例子：P1/P2/P3/P4四个进程的预计执行时间为16，12，4，3个单位时间，那么“先来先服务”算法的进程平均周转时间：`t = (16 + 12 + 4 + 3)/4 = 28`.

### 2.短进程优先
是非剥夺式算法，该算法先调度预计时间较短的进程。

缺点：进程的预计执行时间无法准确估算；如果短进程较多，可能存在长进程饥饿现象；未考虑有些进程的紧迫程度。

例子：P1/P2/P3/P4四个进程的预计执行时间为16，12，4，3个单位时间，那么“短进程优先”算法，将进程按预计执行时间排序，为3，4，12,16，进程平均周转时间：`t = (3 + 4 + 12 + 16)/4 = 28`，但和FCFS相比，该算法降低了进程的平均等待时间，提高了系统吞吐量。

### 3.时间片轮转算法
是抢占式算法，该算法给每个进程分配一个时间片，允许它执行一个时间片的时间，时间片结束未执行完时，强行抢占处理器使用权，该进程插入到就绪队列尾，等待下一次调度。若进程在该时间片内执行完，无需等待时间片结束，直接交出CPU使用权。

由于进程切换需要额外开销，如果时间片过短，频繁切换将会增大开销，如果时间片过长，进程调度等待时间过长，响应时间将边长。因此时间片的确定需要综合考虑多个因素。


缺点：该算法的进程周转时间和平均周转时间并不比前两种算法小，加上频繁切换进程的时间，平均周转时间会更长。
优点：设置合理的时间片能满足用户相应时间的需求。


### 4.基于优先级的调度算法
   













 
